<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boberts Podcast Maker - 30 Min Daily Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #374151;
            border-top: 4px solid #3B82F6;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .glowing-border { box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); }
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active {
            background-color: #3B82F6;
            color: white;
            border-bottom-color: transparent;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4 relative">

    <div class="w-full max-w-4xl mx-auto p-6 md:p-8 bg-gray-800 rounded-2xl shadow-2xl space-y-6">
        <div class="text-center">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Boberts Daily Podcast</h1>
            <p class="text-gray-400 mt-2">Your personalized 30-minute morning show.</p>
        </div>

        <div class="flex justify-between items-center border-b border-gray-700">
            <nav class="flex space-x-2" aria-label="Tabs">
                <button class="tab-btn active font-medium py-2 px-4 rounded-t-lg text-gray-300" data-tab="generator">Daily Show</button>
                <button class="tab-btn font-medium py-2 px-4 rounded-t-lg text-gray-300" data-tab="text-to-audio">Custom TTS</button>
            </nav>
            <button id="open-settings-btn" class="text-gray-400 hover:text-white pb-2 pr-2 transition flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                Profile Setup
            </button>
        </div>

        <div id="generator" class="tab-content active space-y-4">
            <div class="bg-gray-700/50 p-4 rounded-lg border border-gray-600 mb-4">
                <p class="text-sm text-gray-300">Ready to build today's 30-minute show. The AI will pull your saved profile data, search the web for today's news, and generate a full morning-show style broadcast.</p>
            </div>
            
            <button id="generateBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-xl text-lg shadow-lg transition duration-300 flex items-center justify-center glowing-border">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                Generate Today's Show
            </button>

            <div id="loading" class="hidden flex flex-col items-center justify-center py-8 space-y-4 bg-gray-800 rounded-lg border border-gray-700 mt-4">
                <div class="loader"></div>
                <h3 class="text-xl font-semibold text-blue-400">Building your 30-minute show...</h3>
                <p id="loading-message" class="text-gray-400 text-center max-w-md">Initializing AI engines...</p>
                <div class="w-full max-w-md bg-gray-700 rounded-full h-2.5 mt-2">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p class="text-xs text-gray-500 mt-2">Note: Multi-voice rendering takes about 4-5 minutes to avoid API rate limits.</p>
            </div>

            <div id="podcast-output" class="hidden space-y-6 pt-4 mt-4">
                <div class="bg-gray-700 p-6 rounded-xl border border-gray-600 shadow-inner">
                    <h2 class="text-2xl font-bold text-white mb-4 flex items-center">
                        <span class="bg-green-500 w-3 h-3 rounded-full mr-3 animate-pulse"></span>
                        Today's Broadcast
                    </h2>
                    <div id="audio-player-container" class="w-full mb-4"></div>
                    <button id="shareBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">Share Link to Episode</button>
                </div>

                <div class="p-4 bg-gray-700 rounded-lg border border-gray-600">
                    <h3 class="font-semibold text-lg mb-3 text-blue-300">Full Script Transcript</h3>
                    <div id="summary" class="text-gray-300 whitespace-pre-wrap leading-relaxed h-96 overflow-y-auto pr-2 custom-scrollbar text-sm"></div>
                </div>
            </div>
        </div>

        <div id="text-to-audio" class="tab-content space-y-4">
            <label for="tts-input" class="block text-sm font-medium text-gray-300">Paste Custom Text</label>
            <textarea id="tts-input" rows="8" class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 transition duration-300" placeholder="Paste any text here to convert it to audio..."></textarea>
            <button id="tts-generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">Create Audio</button>
            <div id="tts-loading" class="text-center hidden py-4"><div class="loader mx-auto"></div><p class="mt-4 text-gray-400">Processing audio...</p></div>
            <div id="tts-audio-container" class="bg-gray-700 p-4 rounded-lg hidden border border-gray-600"></div>
        </div>

        <div id="error" class="hidden bg-red-900/50 border border-red-700 text-red-200 px-4 py-4 rounded-lg flex items-start" role="alert">
            <svg class="w-6 h-6 mr-3 text-red-400 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <div>
                <strong class="font-bold block">Error</strong>
                <span class="block sm:inline" id="error-message"></span>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-85 hidden flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-2xl p-6 md:p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto border border-gray-600 shadow-2xl">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Host Profile Setup</h2>
                    <p class="text-gray-400 mt-1">Tell the AI what to cover. You only have to do this once.</p>
                </div>
                <button id="close-settings-btn" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>
            
            <form id="profile-form" class="space-y-5 mt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Name</label>
                        <input type="text" id="prof-name" value="Rob" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Location (Specific)</label>
                        <input type="text" id="prof-location" value="Dunnville and Brantford, Ontario" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Weather Rules</label>
                    <input type="text" id="prof-weather" value="Always include the wind chill factor." class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Sports Teams</label>
                    <input type="text" id="prof-sports" value="Philadelphia Flyers, Green Bay Packers" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Work & Industry</label>
                    <input type="text" id="prof-work" value="Contractor Sales, Beaver Homes and Cottages, lumber estimating" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-1">Hobbies, Tech & Pets</label>
                    <textarea id="prof-hobbies" rows="3" class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">IPTV services and tech, Retro console emulation (Nvidia Shield, Daijish≈ç), Tony Hawk games, AI app development, smart glasses, and hanging with my 100lb Mastiff/Bulldog mix, Harvey.</textarea>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-xl text-lg transition duration-300 shadow-lg">Save Profile Settings</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- STEP 1: PASTE YOUR API KEY HERE ---
        const API_KEY = "PASTE_YOUR_API_KEY_HERE"; 
        // -----------------------------------------

        const RESEARCH_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${API_KEY}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${API_KEY}`;

        const tabs = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const generateBtn = document.getElementById('generateBtn');
        const podcastOutputDiv = document.getElementById('podcast-output');
        const loadingDiv = document.getElementById('loading');
        const loadingMessage = document.getElementById('loading-message');
        const progressBar = document.getElementById('progress-bar');
        const audioPlayerContainer = document.getElementById('audio-player-container');
        const summaryP = document.getElementById('summary');
        const errorDiv = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');

        const settingsModal = document.getElementById('settings-modal');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const profileForm = document.getElementById('profile-form');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(item => item.classList.remove('active'));
                tab.classList.add('active');
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        function checkProfile() {
            const savedProfile = localStorage.getItem('bobertsPodcastProfile');
            if (!savedProfile) {
                settingsModal.classList.remove('hidden');
            } else {
                const data = JSON.parse(savedProfile);
                document.getElementById('prof-name').value = data.name || '';
                document.getElementById('prof-location').value = data.location || '';
                document.getElementById('prof-weather').value = data.weather || '';
                document.getElementById('prof-sports').value = data.sports || '';
                document.getElementById('prof-work').value = data.work || '';
                document.getElementById('prof-hobbies').value = data.hobbies || '';
            }
        }

        profileForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const profileData = {
                name: document.getElementById('prof-name').value,
                location: document.getElementById('prof-location').value,
                weather: document.getElementById('prof-weather').value,
                sports: document.getElementById('prof-sports').value,
                work: document.getElementById('prof-work').value,
                hobbies: document.getElementById('prof-hobbies').value
            };
            localStorage.setItem('bobertsPodcastProfile', JSON.stringify(profileData));
            settingsModal.classList.add('hidden');
        });

        openSettingsBtn.addEventListener('click', () => settingsModal.classList.remove('hidden'));
        closeSettingsBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));

        generateBtn.addEventListener('click', async () => {
            if (API_KEY === "AIzaSyAuQxfnvQ8LYfQe9h2Nj7lXs2ynrvRwbjs" || !API_KEY) {
                showError("Please paste your Google Gemini API key into the script.");
                return;
            }

            const savedProfile = localStorage.getItem('bobertsPodcastProfile');
            if (!savedProfile) {
                settingsModal.classList.remove('hidden');
                return;
            }
            const profile = JSON.parse(savedProfile);

            const todayOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const todayString = new Date().toLocaleDateString('en-CA', todayOptions);

            resetUI();
            loadingDiv.classList.remove('hidden');
            podcastOutputDiv.classList.add('hidden');

            // The updated segment architecture
            const segments = [
                `Segment 1: Show intro, high-energy banter between the two hosts, and a detailed deep-dive into the local weather for ${profile.location}. Must follow this rule: ${profile.weather}`,
                `Segment 2: Extensive sports update. Start by searching for the biggest global sporting events happening right now (specifically the current events of the Winter Olympics), and then transition into commentary on the listener's favorite teams: ${profile.sports}.`,
                `Segment 3: Industry News and deep dive. Focus heavily on: ${profile.work}. Discuss current market trends, building materials, and contractor challenges.`,
                `Segment 4: The "Morning Radio Prep" segment. Search the web for bizarre daily news, "stupid criminals," funny viral stories, and weird current events. The hosts should be laughing and bantering about the absurdity of the stories, just like a real morning radio show.`,
                `Segment 5: Tech, hobbies, and lifestyle talk focusing on ${profile.hobbies}. Follow this with a quick daily wrap-up and the show outro.`
            ];

            let fullScript = "";
            let audioPcmArrays = [];
            let currentSampleRate = 24000;

            try {
                // STEP 1: GENERATE SCRIPT CHUNKS
                for (let i = 0; i < segments.length; i++) {
                    updateProgress(`Writing script segment ${i + 1} of 5...`, ((i) / (segments.length * 2)) * 100);
                    
                    const systemPrompt = `You are the executive producer and head writer for a daily 30-minute morning show podcast. The show is hosted by a dynamic duo (Host 1 is male, Host 2 is female). 
                    CRITICAL RULES:
                    1. TODAY'S DATE IS STRICTLY: ${todayString}. Speak about today as the current day. Do not talk about tomorrow.
                    2. Address the listener (${profile.name}), but USE THEIR NAME VERY SPARINGLY. You are forbidden from using their name more than once per segment. Overusing the name sounds robotic.
                    3. Strictly localize the weather forecast to ${profile.location}. Do not give a generic regional forecast.
                    4. Write highly detailed, conversational scripts of 800-900 words per segment. Expand on topics.
                    5. Format the script clearly with speaker tags EXACTLY like this: "HOST 1:" and "HOST 2:"`;
                    
                    const scriptResponse = await generateWithRetry(RESEARCH_API_URL, {
                        contents: [{ parts: [{ text: segments[i] }] }],
                        tools: [{ "googleSearch": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                    });

                    const segmentText = scriptResponse.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!segmentText) throw new Error(`Failed to write segment ${i + 1}`);
                    
                    fullScript += `\n\n--- SEGMENT ${i + 1} ---\n\n` + segmentText;
                    summaryP.textContent = fullScript;
                }

                // STEP 2: PARSE TEXT FOR MULTI-VOICE AND GENERATE AUDIO
                const dialogueRegex = /(HOST 1:|HOST 2:)([\s\S]*?)(?=(HOST 1:|HOST 2:|$))/g;
                let match;
                let dialogueBlocks = [];
                
                while ((match = dialogueRegex.exec(fullScript)) !== null) {
                    if (match[2].trim().length > 0) {
                        dialogueBlocks.push({ speaker: match[1].trim(), text: match[2].trim() });
                    }
                }

                for (let i = 0; i < dialogueBlocks.length; i++) {
                    let block = dialogueBlocks[i];
                    updateProgress(`Recording audio line ${i + 1} of ${dialogueBlocks.length}...`, 50 + ((i / dialogueBlocks.length) * 50));
                    
                    let voiceChoice = block.speaker.includes("1") ? "Charon" : "Aoede";

                    const ttsResponse = await generateWithRetry(TTS_API_URL, {
                        contents: [{ parts: [{ text: block.text }] }],
                        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voiceChoice } } } }
                    });

                    const audioPart = ttsResponse?.candidates?.[0]?.content?.parts?.[0];
                    if (!audioPart?.inlineData?.data) throw new Error("Failed to generate audio data.");
                    
                    const mimeType = audioPart.inlineData.mimeType;
                    currentSampleRate = parseInt(mimeType.match(/rate=(\d+)/)[1], 10) || 24000;
                    
                    const pcmData = new Int16Array(base64ToArrayBuffer(audioPart.inlineData.data));
                    audioPcmArrays.push(pcmData);

                    // SMART THROTTLE: 4-second delay to absolutely ensure we stay under the 15 RPM free tier limit
                    await new Promise(r => setTimeout(r, 4000));
                }

                // STEP 3: STITCH AUDIO TOGETHER
                updateProgress("Finalizing episode...", 99);
                const totalLength = audioPcmArrays.reduce((acc, arr) => acc + arr.length, 0);
                const combinedPcm = new Int16Array(totalLength);
                let offset = 0;
                for (let arr of audioPcmArrays) {
                    combinedPcm.set(arr, offset);
                    offset += arr.length;
                }

                const wavBlob = pcmToWav(combinedPcm, currentSampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audioElement = document.createElement('audio');
                audioElement.controls = true;
                audioElement.src = audioUrl;
                audioElement.className = "w-full rounded-lg shadow-md";
                audioPlayerContainer.appendChild(audioElement);

                loadingDiv.classList.add('hidden');
                podcastOutputDiv.classList.remove('hidden');

            } catch (err) {
                console.error(err);
                showError(err.message || "An error occurred while building the podcast.");
            }
        });

        function updateProgress(message, percent) {
            loadingMessage.textContent = message;
            progressBar.style.width = `${percent}%`;
        }

        function resetUI() {
            errorDiv.classList.add('hidden');
            audioPlayerContainer.innerHTML = '';
            summaryP.textContent = '';
            progressBar.style.width = '0%';
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            loadingDiv.classList.add('hidden');
        }

        async function generateWithRetry(url, payload, maxRetries = 3) {
            let attempt = 0;
            while (attempt < maxRetries) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API request failed with status ${response.status}.`);
                    return await response.json();
                } catch (error) {
                    attempt++;
                    if (attempt >= maxRetries) throw error;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
                }
            }
        }

        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) bytes[i] = binary_string.charCodeAt(i);
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const numChannels = 1, bitsPerSample = 16;
            const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
            const blockAlign = numChannels * (bitsPerSample / 8);
            const dataSize = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, byteRate, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        window.addEventListener('load', checkProfile);

    </script>
</body>
</html>
